<!DOCTYPE html>
<html>
<head>
    <title>–í—Å–µ –∑–∞–∫–∞–∑—ã</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        .filters { background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .delete-btn { 
            background: #ff4444; 
            color: white; 
            border: none; 
            padding: 5px 10px; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        .delete-btn:hover { background: #cc0000; }
        .status-new { color: #2196F3; }
        .status-in_progress { color: #FF9800; }
        .status-completed { color: #4CAF50; }
        .status-archived { color: #9E9E9E; }
    </style>
</head>
<body>
    <h1>üìã –í—Å–µ –∑–∞–∫–∞–∑—ã</h1>
    
    <div class="filters">
        <form>
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select name="status">
                <option value="all" {% if current_status == 'all' %}selected{% endif %}>–í—Å–µ</option>
                <option value="new" {% if current_status == 'new' %}selected{% endif %}>–ù–æ–≤—ã–µ</option>
                <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω—ã</option>
                <option value="archived" {% if current_status == 'archived' %}selected{% endif %}>–ê—Ä—Ö–∏–≤</option>
            </select>
            
            <label>–ü–∞—Ä—Ç–Ω—ë—Ä:</label>
            <select name="partner">
                <option value="all" {% if current_partner == 'all' %}selected{% endif %}>–í—Å–µ</option>
                {% for partner in partners %}
                <option value="{{ partner.id }}" {% if current_partner == partner.id|string %}selected{% endif %}>
                    {{ partner.first_name }} (@{{ partner.username }})
                </option>
                {% endfor %}
            </select>
            
            <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </form>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>–ö–ª–∏–µ–Ω—Ç</th>
                <th>–¢–∏–ø –±–æ—Ç–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°—É–º–º–∞</th>
                <th>–î–∞—Ç–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for item in orders %}
            <tr>
                <td>#{{ item.order.id }}</td>
                <td>
                    {% if item.user %}
                        {{ item.user.first_name }} {{ item.user.last_name or '' }}
                        (@{{ item.user.username or '–Ω–µ—Ç' }})
                    {% else %}
                        –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
                    {% endif %}
                </td>
                <td>{{ item.order.bot_type }}</td>
                <td class="status-{{ item.order.status }}">
                    {% if item.order.status == 'new' %}üÜï –ù–æ–≤—ã–π
                    {% elif item.order.status == 'in_progress' %}‚è≥ –í —Ä–∞–±–æ—Ç–µ
                    {% elif item.order.status == 'completed' %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω
                    {% elif item.order.status == 'archived' %}üóÑÔ∏è –ê—Ä—Ö–∏–≤
                    {% else %}{{ item.order.status }}
                    {% endif %}
                </td>
                <td>{{ item.order.amount }}{{ currency }}</td>
                <td>{{ item.order.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td>
                    <button class="delete-btn" onclick="deleteOrder({{ item.order.id }})" 
                            title="–£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                    <br>
                    <select onchange="updateStatus({{ item.order.id }}, this.value)" 
                            style="margin-top: 5px; padding: 3px;">
                        <option value="new" {% if item.order.status == 'new' %}selected{% endif %}>–ù–æ–≤—ã–π</option>
                        <option value="in_progress" {% if item.order.status == 'in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="completed" {% if item.order.status == 'completed' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                        <option value="archived" {% if item.order.status == 'archived' %}selected{% endif %}>–í –∞—Ä—Ö–∏–≤</option>
                    </select>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
    function deleteOrder(orderId) {
        if (confirm('‚ùå –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ #' + orderId + '?\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
            fetch('/api/delete_order/' + orderId, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (data.message || data.error));
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error);
            });
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    function updateStatus(orderId, newStatus) {
        fetch('/api/update_order_status/' + orderId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
                location.reload();
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        });
    }
    </script>
</body>
</html>
